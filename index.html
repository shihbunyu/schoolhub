<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskTap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    },
                    fontSize: {
                        'mobile-lg': '1.25rem',
                        'mobile-xl': '1.5rem',
                        'mobile-2xl': '1.75rem',
                        'mobile-3xl': '2rem'
                    }
                }
            },
            darkMode: 'class'
        }    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            padding-bottom: 72px; /* Space for bottom navigation */
        }
        .bottom-nav {
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            height: 72px;
        }
        .nav-active {
            color: #5D5CDE;
        }
        .nav-active .nav-text {
            font-weight: 600;
        }
        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-red {
            background-color: #EF4444;
            box-shadow: 0 0 5px #EF4444;
        }
        .status-green {
            background-color: #10B981;
            box-shadow: 0 0 5px #10B981;
        }
        .student-task-card {
            transition: background-color 0.3s ease;
        }
        .student-task-card.completed {
            background-color: rgba(16, 185, 129, 0.1);
        }
        .student-task-card.completed .task-checkbox {
            border-color: #10B981;
            background-color: #10B981;
        }
        .screen-time-banner {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                opacity: 0.8;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.8;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <!-- Main Content Area -->
    <main class="container mx-auto px-4 py-4 pb-20">
        <!-- Main Section (App Introduction) -->
        <section id="main-section" class="section-content">
            <div class="relative rounded-xl overflow-hidden mb-8 min-h-[240px] flex items-center">
                <!-- Background image with overlay -->
                <div class="absolute inset-0">
                    <div class="absolute inset-0 bg-gradient-to-r from-primary/90 to-primary/70 mix-blend-multiply"></div>
                    <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?q=80&w=2000')] bg-cover bg-center"></div>
                </div>
                <!-- Content -->
                <div class="relative px-5 py-10 text-white z-10">
                    <h1 class="text-mobile-3xl font-bold mb-3">TaskTap</h1>
                    <p class="text-mobile-xl mb-6">Connect parents, students & school</p>
                    <button data-section="homework" class="hero-btn bg-white text-primary hover:bg-gray-100 px-6 py-3 rounded-full font-bold text-mobile-lg shadow-md transition-all">
                        Try Homework Tool
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-5 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5">
                    <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-tasks text-blue-600 dark:text-blue-400 text-xl"></i>
                    </div>
                    <h3 class="text-mobile-xl font-semibold mb-2 text-gray-800 dark:text-white">Homework Tool</h3>
                    <p class="text-mobile-lg text-gray-600 dark:text-gray-300">
                        Scan and track homework assignments in one place.
                    </p>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5">
                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-calendar-alt text-green-600 dark:text-green-400 text-xl"></i>
                    </div>
                    <h3 class="text-mobile-xl font-semibold mb-2 text-gray-800 dark:text-white">School Calendar</h3>
                    <p class="text-mobile-lg text-gray-600 dark:text-gray-300">
                        Stay updated with events and activities.
                    </p>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5">
                    <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-shield-alt text-purple-600 dark:text-purple-400 text-xl"></i>
                    </div>
                    <h3 class="text-mobile-xl font-semibold mb-2 text-gray-800 dark:text-white">Parent Controls</h3>
                    <p class="text-mobile-lg text-gray-600 dark:text-gray-300">
                        Monitor student activities and progress.
                    </p>
                </div>
            </div>
            
            <h2 class="text-mobile-xl font-bold mb-4 text-gray-800 dark:text-white">Created By</h2>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-8">
                <p class="text-mobile-lg text-gray-600 dark:text-gray-300 mb-4">
                    SSCPS's Grade 6 students with Poe AI:
                </p>
                <div class="flex flex-wrap gap-4 justify-center">
                    <div class="flex flex-col items-center">
                        <div class="w-14 h-14 bg-primary/20 rounded-full flex items-center justify-center mb-2">
                            <span class="text-primary text-mobile-xl font-bold">J</span>
                        </div>
                        <span class="text-gray-800 dark:text-gray-200 text-mobile-lg">Jason</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-14 h-14 bg-primary/20 rounded-full flex items-center justify-center mb-2">
                            <span class="text-primary text-mobile-xl font-bold">G</span>
                        </div>
                        <span class="text-gray-800 dark:text-gray-200 text-mobile-lg">Glenn</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-14 h-14 bg-primary/20 rounded-full flex items-center justify-center mb-2">
                            <span class="text-primary text-mobile-xl font-bold">V</span>
                        </div>
                        <span class="text-gray-800 dark:text-gray-200 text-mobile-lg">Victoria</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-14 h-14 bg-primary/20 rounded-full flex items-center justify-center mb-2">
                            <span class="text-primary text-mobile-xl font-bold">I</span>
                        </div>
                        <span class="text-gray-800 dark:text-gray-200 text-mobile-lg">Ian</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-14 h-14 bg-primary/20 rounded-full flex items-center justify-center mb-2">
                            <span class="text-primary text-mobile-xl font-bold">A</span>
                        </div>
                        <span class="text-gray-800 dark:text-gray-200 text-mobile-lg">Ashton</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Homework Extraction Section -->
        <section id="homework-section" class="section-content hidden">
            <h1 class="text-mobile-2xl font-bold mb-4 text-gray-800 dark:text-white">Homework Tool</h1>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-5">
                <h2 class="text-mobile-xl font-semibold mb-2 text-gray-800 dark:text-white">Upload Image</h2>
                <p class="mb-4 text-mobile-lg text-gray-600 dark:text-gray-300">Take a photo of your homework board to extract the text.</p>
                
                <div id="dropArea" class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-6 text-center cursor-pointer hover:border-primary transition-colors">
                    <div class="space-y-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="text-mobile-lg text-gray-600 dark:text-gray-300">Tap to take a photo</p>
                        <input type="file" id="fileInput" class="hidden" accept="image/*" />
                        <button id="selectButton" class="px-5 py-3 bg-primary text-white rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-mobile-lg font-medium">
                            Select Image
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Processing indicator -->
            <div id="processingIndicator" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-5 hidden">
                <div class="flex flex-col items-center space-y-4">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                    <p id="progressText" class="text-mobile-lg text-gray-600 dark:text-gray-300">Processing image...</p>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                        <div id="progressBar" class="bg-primary h-3 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Preview section -->
            <div id="previewContainer" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-5 hidden">
                <h2 class="text-mobile-xl font-semibold mb-3 text-gray-800 dark:text-white">Image Preview</h2>
                <div class="flex justify-center">
                    <img id="imagePreview" class="max-h-64 max-w-full object-contain rounded-lg" alt="Preview" />
                </div>
            </div>
            
            <!-- Results section -->
            <div id="resultsContainer" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 hidden">
                <h2 class="text-mobile-xl font-semibold mb-3 text-gray-800 dark:text-white">Extracted Text</h2>
                <div id="textOutput" class="bg-gray-50 dark:bg-gray-900 p-4 rounded-md whitespace-pre-wrap text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-700 min-h-[100px] max-h-[400px] overflow-y-auto text-mobile-lg"></div>
                <div class="mt-4 flex flex-wrap gap-3">
                    <button id="copyButton" class="px-4 py-3 bg-primary text-white rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed text-mobile-lg font-medium">
                        Copy Text
                    </button>
                    <button id="generateActionsButton" class="px-4 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-mobile-lg font-medium">
                        Get Action Items
                    </button>
                    <button id="newImageButton" class="px-4 py-3 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-mobile-lg font-medium">
                        New Image
                    </button>
                </div>
            </div>
            
            <!-- Chat Window for Action Items -->
            <div id="chatContainer" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-5 hidden">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-mobile-xl font-semibold text-gray-800 dark:text-white">Action Items</h2>
                    <button id="copyChatButton" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary text-mobile-lg">
                        Copy All
                    </button>
                </div>
                
                <div class="bg-gray-100 dark:bg-gray-900 rounded-lg h-[400px] overflow-y-auto p-4">
                    <div id="chatMessages" class="flex flex-col space-y-3">
                        <!-- Chat messages will be inserted here -->
                    </div>
                </div>
                
                <div class="mt-4">
                    <button id="sendToSectionsButton" class="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-mobile-lg font-medium hidden">
                        Send to Parent & Student
                    </button>
                </div>
            </div>
            
            <!-- Error message -->
            <div id="errorContainer" class="bg-red-100 dark:bg-red-900/50 border-l-4 border-red-500 text-red-700 dark:text-red-200 p-4 rounded hidden">
                <p id="errorMessage" class="text-mobile-lg"></p>
            </div>
        </section>

        <!-- Parent Section -->
        <section id="parent-section" class="section-content hidden">
            <h1 class="text-mobile-2xl font-bold mb-4 text-gray-800 dark:text-white">Parent Monitor</h1>
            
            <!-- Screen Time Control -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-5">
                <h2 class="text-mobile-xl font-semibold mb-3 text-gray-800 dark:text-white">Screen Time Control</h2>
                <p class="text-mobile-lg text-gray-600 dark:text-gray-300 mb-4">
                    Manage screen time based on homework completion.
                </p>
                <div class="flex flex-col space-y-3">
                    <button id="unlock30min" class="px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-mobile-lg font-medium">
                        Unlock Screen Time (30 mins)
                    </button>
                    <button id="unlock1day" class="px-4 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 text-mobile-lg font-medium">
                        Unlock Screen Time (1 day)
                    </button>
                </div>
            </div>
            
            <!-- Homework Tracker -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-5">
                <h2 class="text-mobile-xl font-semibold mb-3 text-gray-800 dark:text-white">Homework Monitor</h2>
                <p class="text-mobile-lg text-gray-600 dark:text-gray-300 mb-3">
                    Track completion of homework tasks.
                </p>
                
                <div id="parentNoTasks" class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 text-center">
                    <p class="text-mobile-lg text-gray-600 dark:text-gray-400">No homework tasks available yet.</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">Tasks will appear when generated from the Homework section.</p>
                </div>
                
                <div id="parentTasksList" class="flex flex-col space-y-3 mt-3 hidden">
                    <!-- Task items will be generated here -->
                </div>
            </div>
            
            <!-- Other Controls -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-5">
                <h2 class="text-mobile-xl font-semibold mb-3 text-gray-800 dark:text-white">Other Controls</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                        <h3 class="font-medium text-mobile-lg text-blue-700 dark:text-blue-300 mb-2">Progress Reports</h3>
                        <p class="text-mobile-lg text-gray-600 dark:text-gray-400">Check academic performance</p>
                    </div>
                    <div class="p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800">
                        <h3 class="font-medium text-mobile-lg text-amber-700 dark:text-amber-300 mb-2">Message Teachers</h3>
                        <p class="text-mobile-lg text-gray-600 dark:text-gray-400">Direct messaging with school staff</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Student Section -->
        <section id="student-section" class="section-content hidden">
            <h1 class="text-mobile-2xl font-bold mb-4 text-gray-800 dark:text-white">Student Dashboard</h1>
            
            <!-- Screen Time Status -->
            <div id="screenTimeStatus" class="hidden mb-5">
                <div class="bg-green-600 text-white rounded-lg p-4 screen-time-banner">
                    <div class="flex items-center">
                        <div class="mr-3">
                            <i class="fas fa-gamepad text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-mobile-lg">Screen Time Unlocked!</h3>
                            <p id="screenTimeMessage" class="text-base">You have 30 minutes of free time.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Homework Tasks -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-5">
                <h2 class="text-mobile-xl font-semibold mb-3 text-gray-800 dark:text-white">My Homework</h2>
                <p class="text-mobile-lg text-gray-600 dark:text-gray-300 mb-3">
                    Check off tasks as you complete them.
                </p>
                
                <div id="studentNoTasks" class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 text-center">
                    <p class="text-mobile-lg text-gray-600 dark:text-gray-400">No homework tasks available yet.</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">Tasks will appear when generated from the Homework section.</p>
                </div>
                
                <div id="studentTasksList" class="flex flex-col space-y-3 mt-3 hidden">
                    <!-- Task items will be generated here -->
                </div>
            </div>
            
            <!-- Schedule -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-5">
                <h2 class="text-mobile-xl font-semibold mb-3 text-gray-800 dark:text-white">Today's Schedule</h2>
                <ul class="space-y-3 text-mobile-lg">
                    <li class="text-gray-600 dark:text-gray-300">9:00 AM - English</li>
                    <li class="text-gray-600 dark:text-gray-300">10:30 AM - Math</li>
                    <li class="text-gray-600 dark:text-gray-300">12:00 PM - Lunch</li>
                    <li class="text-gray-600 dark:text-gray-300">1:00 PM - Science</li>
                    <li class="text-gray-600 dark:text-gray-300">2:30 PM - History</li>
                </ul>
            </div>
            
            <!-- Reminders -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-5 mb-5">
                <h2 class="text-mobile-xl font-semibold mb-3 text-gray-800 dark:text-white">Reminders</h2>
                <ul class="space-y-3">
                    <li class="flex items-center text-mobile-lg">
                        <i class="fas fa-bell text-primary mr-2"></i>
                        <span class="text-gray-600 dark:text-gray-300">Bring gym clothes tomorrow</span>
                    </li>
                    <li class="flex items-center text-mobile-lg">
                        <i class="fas fa-bell text-primary mr-2"></i>
                        <span class="text-gray-600 dark:text-gray-300">Library books due Friday</span>
                    </li>
                    <li class="flex items-center text-mobile-lg">
                        <i class="fas fa-bell text-primary mr-2"></i>
                        <span class="text-gray-600 dark:text-gray-300">Permission slip needed</span>
                    </li>
                </ul>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 flex justify-around items-center z-50 border-t border-gray-200 dark:border-gray-700">
        <button data-section="main" class="nav-item flex flex-col items-center justify-center w-1/4 h-full text-gray-600 dark:text-gray-300 nav-active">
            <i class="fas fa-home text-xl mb-1"></i>
            <span class="nav-text text-xs">Main</span>
        </button>
        <button data-section="homework" class="nav-item flex flex-col items-center justify-center w-1/4 h-full text-gray-600 dark:text-gray-300">
            <i class="fas fa-book text-xl mb-1"></i>
            <span class="nav-text text-xs">Homework</span>
        </button>
        <button data-section="parent" class="nav-item flex flex-col items-center justify-center w-1/4 h-full text-gray-600 dark:text-gray-300">
            <i class="fas fa-user-friends text-xl mb-1"></i>
            <span class="nav-text text-xs">Parent</span>
        </button>
        <button data-section="student" class="nav-item flex flex-col items-center justify-center w-1/4 h-full text-gray-600 dark:text-gray-300">
            <i class="fas fa-user-graduate text-xl mb-1"></i>
            <span class="nav-text text-xs">Student</span>
        </button>
    </nav>

    <!-- Theme Toggle Button (Top Right Corner) -->
    <button id="themeToggle" class="fixed top-4 right-4 z-50 bg-white dark:bg-gray-800 p-2 rounded-full shadow-md text-gray-600 dark:text-gray-300">
        <i class="fas fa-moon dark:hidden"></i>
        <i class="fas fa-sun hidden dark:block"></i>
    </button>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // App data store (using in-memory storage)
        const appData = {
            tasks: [],
            screenTimeStatus: {
                unlocked: false,
                until: null,
                duration: null
            },
            
            // Save data (in-memory only)
            saveData: function() {
                // No persistent storage in sandbox environment
                // Data remains in memory during the session
            },
            
            // Load data (initialize default values)
            loadData: function() {
                // No data to load, just use the defaults
            },
            
            // Add tasks (max 10)
            addTasks: function(newTasks) {
                // Take only the first 10 tasks if there are more
                const limitedTasks = newTasks.slice(0, 10);
                
                // Create task objects with IDs and completion status
                const taskObjects = limitedTasks.map((text, index) => ({
                    id: Date.now() + index,
                    text: text.trim(),
                    completed: false,
                    timestamp: new Date().toISOString()
                }));
                
                // Set as new tasks (replacing previous ones)
                this.tasks = taskObjects;
                this.saveData();
                
                // Update UI in both sections
                updateStudentTasksUI();
                updateParentTasksUI();
                
                return taskObjects;
            },
            
            // Update task completion status
            updateTaskStatus: function(taskId, completed) {
                const taskIndex = this.tasks.findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    this.tasks[taskIndex].completed = completed;
                    this.saveData();
                    
                    // Update UI in both sections
                    updateStudentTasksUI();
                    updateParentTasksUI();
                }
            },
            
            // Set screen time status
            setScreenTime: function(duration) {
                const now = new Date();
                let unlockUntil;
                
                if (duration === 30) {
                    // 30 minutes
                    unlockUntil = new Date(now.getTime() + 30 * 60 * 1000);
                } else if (duration === 1440) {
                    // 1 day (24 hours)
                    unlockUntil = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                }
                
                this.screenTimeStatus = {
                    unlocked: true,
                    until: unlockUntil.toISOString(),
                    duration: duration
                };
                
                this.saveData();
                updateScreenTimeUI();
            },
            
            // Check if screen time is currently unlocked
            isScreenTimeUnlocked: function() {
                if (!this.screenTimeStatus.unlocked || !this.screenTimeStatus.until) {
                    return false;
                }
                
                const now = new Date();
                const unlockUntil = new Date(this.screenTimeStatus.until);
                
                return now < unlockUntil;
            },
            
            // Get remaining screen time in minutes
            getRemainingScreenTime: function() {
                if (!this.isScreenTimeUnlocked()) {
                    return 0;
                }
                
                const now = new Date();
                const unlockUntil = new Date(this.screenTimeStatus.until);
                const diffMs = unlockUntil - now;
                
                return Math.max(0, Math.floor(diffMs / (60 * 1000)));
            }
        };

        // DOM elements for navigation
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.section-content');
        const themeToggle = document.getElementById('themeToggle');
        const heroBtn = document.querySelector('.hero-btn');

        // DOM elements for OCR functionality
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const selectButton = document.getElementById('selectButton');
        const processingIndicator = document.getElementById('processingIndicator');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const resultsContainer = document.getElementById('resultsContainer');
        const textOutput = document.getElementById('textOutput');
        const copyButton = document.getElementById('copyButton');
        const generateActionsButton = document.getElementById('generateActionsButton');
        const newImageButton = document.getElementById('newImageButton');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const copyChatButton = document.getElementById('copyChatButton');
        const sendToSectionsButton = document.getElementById('sendToSectionsButton');

        // DOM elements for task management
        const studentTasksList = document.getElementById('studentTasksList');
        const studentNoTasks = document.getElementById('studentNoTasks');
        const parentTasksList = document.getElementById('parentTasksList');
        const parentNoTasks = document.getElementById('parentNoTasks');
        
        // DOM elements for screen time control
        const unlock30min = document.getElementById('unlock30min');
        const unlock1day = document.getElementById('unlock1day');
        const screenTimeStatus = document.getElementById('screenTimeStatus');
        const screenTimeMessage = document.getElementById('screenTimeMessage');

        // Initialize app data from storage
        appData.loadData();

        // Set up screen time update interval
        setInterval(updateScreenTimeUI, 60000); // Update every minute

        // Navigation functionality
        function navigateToSection(sectionId) {
            // Update active nav item
            navItems.forEach(item => {
                const itemSectionId = item.getAttribute('data-section');
                if (itemSectionId === sectionId) {
                    item.classList.add('nav-active');
                    item.classList.remove('text-gray-600', 'dark:text-gray-300');
                } else {
                    item.classList.remove('nav-active');
                    item.classList.add('text-gray-600', 'dark:text-gray-300');
                }
            });
            
            // Show selected section, hide others
            sections.forEach(section => {
                if (section.id === `${sectionId}-section`) {
                    section.classList.remove('hidden');
                    // Scroll to top when changing sections
                    window.scrollTo(0, 0);
                    
                    // If navigating to student or parent section, update tasks UI
                    if (sectionId === 'student') {
                        updateStudentTasksUI();
                        updateScreenTimeUI();
                    } else if (sectionId === 'parent') {
                        updateParentTasksUI();
                    }
                } else {
                    section.classList.add('hidden');
                }
            });
        }

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const sectionId = item.getAttribute('data-section');
                navigateToSection(sectionId);
            });
        });

        // Hero button navigation to homework section
        if (heroBtn) {
            heroBtn.addEventListener('click', () => {
                const sectionId = heroBtn.getAttribute('data-section');
                navigateToSection(sectionId);
            });
        }

        // Theme toggle
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
        });
        
        // Screen time control buttons
        unlock30min.addEventListener('click', () => {
            appData.setScreenTime(30); // 30 minutes
            alert('Screen time unlocked for 30 minutes.');
        });
          unlock1day.addEventListener('click', () => {
            appData.setScreenTime(1440); // 24 hours (1440 minutes)
            alert('Screen time unlocked for 1 day.');
        });        
        
        // Grok API Configuration
        const GROK_API_KEY = 'xai-chB1xwHLU8fBB1k0r74KzLh0x5TWTzpHDEzRSXud2kyRaArXs4o9sSha1iKSzRLXwsWE9k73nCY5YguU';
        const GROK_ENDPOINT = 'https://api.x.ai/v1/chat/completions';
        
        // Event listeners for OCR functionality
        selectButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        dropArea.addEventListener('dragover', handleDragOver);
        dropArea.addEventListener('dragleave', handleDragLeave);
        dropArea.addEventListener('drop', handleDrop);
        copyButton.addEventListener('click', copyToClipboard);        generateActionsButton.addEventListener('click', generateActionItems);
        copyChatButton.addEventListener('click', copyChatToClipboard);
        newImageButton.addEventListener('click', resetApp);
        sendToSectionsButton.addEventListener('click', sendActionItemsToSections);

        // Process the image with OCR
        async function processImage(file) {
            // Hide error container if visible
            errorContainer.classList.add('hidden');
            
            // Show image preview
            const url = URL.createObjectURL(file);
            imagePreview.src = url;
            previewContainer.classList.remove('hidden');
            
            // Show processing indicator
            processingIndicator.classList.remove('hidden');
            progressBar.style.width = '20%';
            progressText.textContent = 'Processing with Grok AI...';
            
            // Hide results if visible
            resultsContainer.classList.add('hidden');
            
            try {
                // Process with Grok OCR
                progressBar.style.width = '50%';
                const extractedText = await performGrokOCR(file);
                
                if (!extractedText || extractedText.trim() === '') {
                    throw new Error('No text could be extracted from the image');
                }
                
                // Display results
                progressBar.style.width = '100%';
                textOutput.textContent = extractedText;
                resultsContainer.classList.remove('hidden');
                copyButton.disabled = !extractedText.trim();
                
                // Hide processing indicator
                processingIndicator.classList.add('hidden');
                
                // Scroll to results
                resultsContainer.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                processingIndicator.classList.add('hidden');
                showError(error.message);
            }
        }        // Process with Grok OCR
        async function performGrokOCR(file) {
            try {
                // Convert image to base64
                const base64Image = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const response = await fetch(GROK_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROK_API_KEY}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },                    body: JSON.stringify({
                        model: "grok-2-vision-1212",
                        messages: [
                            {
                                role: "system",
                                content: "You are a text extraction assistant. Your task is to carefully extract all text from images, preserving formatting and structure. Only output the extracted text, nothing else."
                            },
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: "Extract all text from this image. Maintain original formatting and structure:"
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            "url": `data:image/jpeg;base64,${base64Image}`
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 2000,
                        temperature: 0.2
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Grok API Error:', errorData);
                    throw new Error(errorData.error?.message || 'Failed to process image with Grok AI');
                }

                const result = await response.json();
                if (!result.choices || !result.choices[0]?.message?.content) {
                    throw new Error('Invalid response from Grok AI');
                }
                return result.choices[0].message.content;
            } catch (error) {
                console.error('OCR Error:', error);
                throw new Error('Error processing image: ' + error.message);
            }
        }

        // Generate action items using Grok AI
        async function generateActionItemsWithGrok() {
            try {
                const extractedText = textOutput.textContent;
                if (!extractedText) {
                    throw new Error('No text available to analyze');
                }

                const response = await fetch(GROK_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROK_API_KEY}`,
                        'Content-Type': 'application/json'
                    },                    body: JSON.stringify({
                        model: "grok-3-mini-fast",
                        messages: [
                            {
                                role: "system",
                                content: "You are a helpful assistant that analyzes text and extracts clear, actionable items. Format your response as a bullet-pointed list. Limit to 10 most important items. Be concise and clear."
                            },
                            {
                                role: "user",
                                content: `Please analyze this text and list the key action items:\n\n${extractedText}`
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to analyze text with Grok AI');
                }

                const result = await response.json();
                // Parse bullet points from the response
                const actionItems = result.choices[0].message.content
                    .split('\n')
                    .filter(item => item.trim().match(/^[-•*]\s+/))
                    .map(item => item.replace(/^[-•*]\s+/, '').trim());
                
                // Clear loading message
                chatMessages.innerHTML = '';
                
                // Add each action item to chat
                actionItems.forEach(item => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'bg-white dark:bg-gray-800 rounded-lg p-4 shadow';
                    messageDiv.innerHTML = marked.parse(`- ${item}`);
                    chatMessages.appendChild(messageDiv);
                });

                sendToSectionsButton.classList.remove('hidden');
                return actionItems;
                
            } catch (error) {
                throw new Error('Error generating action items: ' + error.message);
            }
        }
        
        // Generate action items from extracted text
        async function generateActionItems() {
            const extractedText = textOutput.textContent.trim();
            if (!extractedText) {
                showError('No text to generate action items from');
                return;
            }
            
            // Show processing indicator
            processingIndicator.classList.remove('hidden');
            progressBar.style.width = '30%';
            progressText.textContent = 'Generating action items with Grok AI...';
            
            // Clear previous chat messages
            chatMessages.innerHTML = '';
            chatContainer.classList.add('hidden');
            
            try {
                // Add initial message in chat
                addChatMessage('teacher', 'Here are the action items from the document:');
                
                // Generate action items with Grok
                const actionItems = await generateActionItemsWithGrok(extractedText);
                
                // Display action items in chat interface
                displayActionItemsInChat(actionItems);
                
                // Show chat container and the send to sections button
                chatContainer.classList.remove('hidden');
                sendToSectionsButton.classList.remove('hidden');
                chatContainer.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                processingIndicator.classList.add('hidden');
                showError(error.message);
            }
        }
        
        // Update file handling function to use Grok OCR
        async function handleFileSelect(event) {
            const file = event.target?.files?.[0];
            if (!file) return;
            
            try {
                // Reset UI
                resetError();
                showProcessingUI();
                
                // Show image preview
                const imageUrl = URL.createObjectURL(file);
                imagePreview.src = imageUrl;
                previewContainer.classList.remove('hidden');
                
                // Perform OCR with Grok
                const extractedText = await performGrokOCR(file);
                
                // Show results
                showResults(extractedText);
                
            } catch (error) {
                showError(error.message);
            } finally {
                hideProcessingUI();
            }
        }

        // Hide processing UI
        function hideProcessingUI() {
            processingIndicator.classList.add('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '';
        }

        // Reset error state
        function resetError() {
            errorContainer.classList.add('hidden');
            errorMessage.textContent = '';
        }
        
        // Show processing UI
        function showProcessingUI() {
            processingIndicator.classList.remove('hidden');
            progressBar.style.width = '20%';
            progressText.textContent = 'Processing with Grok AI...';
        }

        // Show results
        function showResults(text) {
            textOutput.textContent = text;
            resultsContainer.classList.remove('hidden');
            copyButton.disabled = !text.trim();
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Update Student Tasks UI
        function updateStudentTasksUI() {
            if (appData.tasks.length === 0) {
                studentTasksList.classList.add('hidden');
                studentNoTasks.classList.remove('hidden');
                return;
            }
            
            // Clear existing tasks
            studentTasksList.innerHTML = '';
            
            // Show tasks container, hide "no tasks" message
            studentTasksList.classList.remove('hidden');
            studentNoTasks.classList.add('hidden');
            
            // Add each task to the list
            appData.tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `student-task-card p-4 rounded-lg border border-gray-200 dark:border-gray-700 ${task.completed ? 'completed' : ''}`;
                taskItem.dataset.taskId = task.id;
                
                const taskContent = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1">
                            <div class="mr-3 flex-shrink-0">
                                <div class="task-checkbox w-5 h-5 border-2 border-gray-300 dark:border-gray-600 rounded flex items-center justify-center">
                                    ${task.completed ? '<i class="fas fa-check text-white"></i>' : ''}
                                </div>
                            </div>
                            <p class="text-mobile-lg text-gray-700 dark:text-gray-300">${task.text}</p>
                        </div>
                        <button class="finish-button ml-2 px-3 py-1 text-sm bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 ${task.completed ? 'opacity-50 cursor-not-allowed' : ''}">
                            ${task.completed ? 'Finished' : 'Finish'}
                        </button>
                    </div>
                `;
                
                taskItem.innerHTML = taskContent;
                studentTasksList.appendChild(taskItem);
                
                // Add finish button event listener
                const finishButton = taskItem.querySelector('.finish-button');
                if (!task.completed) {
                    finishButton.addEventListener('click', () => {
                        appData.updateTaskStatus(task.id, true);
                    });
                }
            });
        }
        
        // Update Parent Tasks UI
        function updateParentTasksUI() {
            if (appData.tasks.length === 0) {
                parentTasksList.classList.add('hidden');
                parentNoTasks.classList.remove('hidden');
                return;
            }
            
            // Clear existing tasks
            parentTasksList.innerHTML = '';
            
            // Show tasks container, hide "no tasks" message
            parentTasksList.classList.remove('hidden');
            parentNoTasks.classList.add('hidden');
            
            // Add each task to the list
            appData.tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'p-4 rounded-lg border border-gray-200 dark:border-gray-700';
                
                const formattedDate = new Date(task.timestamp).toLocaleDateString();
                const taskContent = `
                    <div class="flex items-center">
                        <div class="mr-3 flex-shrink-0">
                            <span class="status-light ${task.completed ? 'status-green' : 'status-red'}"></span>
                        </div>
                        <div class="flex-1">
                            <p class="text-mobile-lg text-gray-700 dark:text-gray-300">${task.text}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Added: ${formattedDate}</p>
                        </div>
                        <div class="ml-2 text-sm font-medium ${task.completed ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                            ${task.completed ? 'Completed' : 'Pending'}
                        </div>
                    </div>
                `;
                
                taskItem.innerHTML = taskContent;
                parentTasksList.appendChild(taskItem);
            });
        }
        
        // Update Screen Time UI
        function updateScreenTimeUI() {
            const isUnlocked = appData.isScreenTimeUnlocked();
            const remainingMinutes = appData.getRemainingScreenTime();
            
            if (isUnlocked && remainingMinutes > 0) {
                screenTimeStatus.classList.remove('hidden');
                
                // Format the remaining time message
                let timeMessage;
                if (remainingMinutes < 60) {
                    timeMessage = `${remainingMinutes} minute${remainingMinutes !== 1 ? 's' : ''}`;
                } else {
                    const hours = Math.floor(remainingMinutes / 60);
                    const mins = remainingMinutes % 60;
                    
                    if (mins === 0) {
                        timeMessage = `${hours} hour${hours !== 1 ? 's' : ''}`;
                    } else {
                        timeMessage = `${hours} hour${hours !== 1 ? 's' : ''} and ${mins} minute${mins !== 1 ? 's' : ''}`;
                    }
                }
                
                screenTimeMessage.textContent = `You have ${timeMessage} of free time.`;
            } else {
                screenTimeStatus.classList.add('hidden');
                
                // If time expired, update the status
                if (appData.screenTimeStatus.unlocked && !isUnlocked) {
                    appData.screenTimeStatus.unlocked = false;
                    appData.saveData();
                }
            }
        }

        // Send Action Items to Student and Parent Sections
        function sendActionItemsToSections() {
            const actionItems = [];
            
            // Get all messages from the chat (excluding the first intro message and last parent response)
            const messages = Array.from(chatMessages.querySelectorAll('.chat-message'));
            for (let i = 1; i < messages.length - 1; i++) {
                const messageText = messages[i].querySelector('div').textContent;
                actionItems.push(messageText);
            }
            
            if (actionItems.length === 0) {
                alert('No action items to send.');
                return;
            }
            
            // Add tasks to the app data
            appData.addTasks(actionItems);
            
            // Show confirmation and navigate to student section
            alert('Action items sent to Student and Parent sections!');
            navigateToSection('student');
        }

        // Handle file selection
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processImage(file);
            }
        }

        // Handle drag and drop
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.add('border-primary');
            dropArea.classList.add('bg-primary/5');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.remove('border-primary');
            dropArea.classList.remove('bg-primary/5');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.remove('border-primary');
            dropArea.classList.remove('bg-primary/5');
            
            const dt = e.dataTransfer;
            const file = dt.files[0];
            
            if (file && file.type.startsWith('image/')) {
                processImage(file);
            } else {
                showError('Please upload an image file');
            }
        }        // Copy text to clipboard
        function copyToClipboard() {
            const text = textOutput.textContent;
            if (!text.trim()) return;
            
            navigator.clipboard.writeText(text)
                .then(() => {
                    const originalText = copyButton.textContent;
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                    }, 2000);
                })
                .catch(err => {
                    showError('Failed to copy text: ' + err.message);
                });
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            errorContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Generate action items from extracted text
        async function generateActionItems() {
            const extractedText = textOutput.textContent.trim();
            if (!extractedText) {
                showError('No text to generate action items from');
                return;
            }
            
            // Show processing indicator
            processingIndicator.classList.remove('hidden');
            progressBar.style.width = '30%';
            progressText.textContent = 'Generating action items with Grok AI...';
            
            // Clear previous chat messages
            chatMessages.innerHTML = '';
            chatContainer.classList.add('hidden');
            
            try {
                // Add initial message in chat
                addChatMessage('teacher', 'Here are the action items from the document:');
                
                // Generate action items with Grok
                const actionItems = await generateActionItemsWithGrok(extractedText);
                
                // Display action items in chat interface
                displayActionItemsInChat(actionItems);
                
                // Show chat container and the send to sections button
                chatContainer.classList.remove('hidden');
                sendToSectionsButton.classList.remove('hidden');
                chatContainer.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                processingIndicator.classList.add('hidden');
                showError(error.message);
            }
        }
        
        // Parse action items from Claude's response
        function parseActionItems(text) {
            // Split by bullet points or numbered items
            let items = text.split(/\n[•\-\*]\s+|\n\d+\.\s+/);
            
            // Remove any empty items or headings
            items = items.filter(item => 
                item.trim() !== '' && 
                !item.trim().startsWith('#') &&
                !item.trim().startsWith('Action Items')
            );
            
            // If we couldn't split by bullets, try splitting by newlines
            if (items.length <= 1) {
                items = text.split('\n').filter(item => 
                    item.trim() !== '' && 
                    !item.trim().startsWith('#') &&
                    !item.trim().startsWith('Action Items')
                );
            }
            
            // Limit to 10 items
            return items.slice(0, 10);
        }
        
        // Display action items in chat interface
        function displayActionItemsInChat(actionItems) {
            // Add a small delay between messages for a more natural chat feel
            const messageDelay = 300;
            
            actionItems.forEach((item, index) => {
                setTimeout(() => {
                    addChatMessage('teacher', item.trim());
                    
                    // Scroll to the latest message
                    const chatWindow = chatMessages.parentElement;
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    
                    // Add a "Thank you" message after the last action item
                    if (index === actionItems.length - 1) {
                        setTimeout(() => {
                            addChatMessage('parent', 'Thank you for the update!');
                            chatWindow.scrollTop = chatWindow.scrollHeight;
                        }, 500);
                    }
                }, index * messageDelay);
            });
        }
        
        // Add a message to the chat interface
        function addChatMessage(sender, text) {
            const messageEl = document.createElement('div');
            messageEl.className = sender === 'teacher' 
                ? 'chat-message self-start max-w-[80%]'
                : 'chat-message self-end max-w-[80%]';
            
            const bubbleEl = document.createElement('div');
            bubbleEl.className = sender === 'teacher'
                ? 'bg-primary text-white p-3 rounded-lg rounded-tl-none shadow'
                : 'bg-gray-300 dark:bg-gray-700 p-3 rounded-lg rounded-tr-none shadow text-gray-800 dark:text-white';
            
            bubbleEl.textContent = text;
            messageEl.appendChild(bubbleEl);
            
            const timeEl = document.createElement('div');
            timeEl.className = 'text-xs text-gray-500 mt-1';
            timeEl.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageEl.appendChild(timeEl);
            chatMessages.appendChild(messageEl);
        }
        
        // Copy chat content to clipboard
        function copyChatToClipboard() {
            const chatContent = Array.from(chatMessages.querySelectorAll('.chat-message'))
                .map(msg => {
                    const isSender = msg.classList.contains('self-end');
                    const text = msg.querySelector('div').textContent;
                    return `${isSender ? 'Parent' : 'Teacher'}: ${text}`;
                })
                .join('\n\n');
            
            if (!chatContent) return;
            
            navigator.clipboard.writeText(chatContent)
                .then(() => {
                    const originalText = copyChatButton.textContent;
                    copyChatButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyChatButton.textContent = originalText;
                    }, 2000);
                })
                .catch(err => {
                    showError('Failed to copy chat: ' + err.message);
                });
        }
        
        // Reset app for new image
        function resetApp() {
            fileInput.value = '';
            textOutput.textContent = '';
            resultsContainer.classList.add('hidden');
            previewContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
            chatContainer.classList.add('hidden');
            chatMessages.innerHTML = '';
            sendToSectionsButton.classList.add('hidden');
        }
        
        // Initial UI updates
        updateStudentTasksUI();
        updateParentTasksUI();
        updateScreenTimeUI();
    </script>
</body>
</html>